<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Imp Cubes: Ultimate</title>
    <link rel="icon" type="image/png" href="https://media.discordapp.net/attachments/1286433136804106282/1472114823369330689/image.png?ex=69916544&is=699013c4&hm=6e53418ccc28321ed6703073c2da8530a6e16e4680acae446d8a83c2372b6352">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #00b894; --secondary: #0984e3; --bg-dark: #111; --text: #eee; }
        body { margin: 0; background: url('https://media.discordapp.net/attachments/1286433136804106282/1472114823369330689/image.png') no-repeat center center fixed; background-size: cover; overflow: hidden; font-family: 'Nunito', sans-serif; color: var(--text); user-select: none; }
        canvas { display: block; }

        /* BACKDROP BLUR */
        #backdrop { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: -1; }

        /* TOP NAV */
        #navbar { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background: rgba(0,0,0,0.6); border-bottom: 2px solid rgba(255,255,255,0.1); }
        .nav-logo { font-family: 'Fredoka One'; font-size: 28px; color: white; text-transform: uppercase; letter-spacing: 2px; }
        .nav-links { display: flex; gap: 20px; }
        .nav-btn { background: transparent; border: none; color: #aaa; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .nav-btn:hover, .nav-btn.active { color: white; border-bottom: 2px solid var(--primary); }
        .account-box { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 4px; }
        .currency { color: gold; font-weight: bold; }

        /* DEADSHOT MAIN MENU */
        #deadshotMenu { display: none; height: calc(100vh - 80px); position: relative; }
        .center-char { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .play-btn-large { 
            background: var(--secondary); border: none; padding: 15px 60px; font-size: 30px; color: white; font-family: 'Fredoka One'; 
            border-radius: 4px; cursor: pointer; box-shadow: 0 5px 0 #0056b3; transition: 0.1s; margin-top: 20px; text-transform: uppercase;
        }
        .play-btn-large:hover { filter: brightness(1.1); }
        .play-btn-large:active { transform: translateY(4px); box-shadow: none; }
        
        .side-panel { position: absolute; top: 100px; bottom: 100px; width: 250px; background: rgba(0,0,0,0.5); padding: 20px; border-radius: 8px; }
        .left-panel { left: 30px; border-left: 4px solid var(--primary); }
        .right-panel { right: 30px; border-right: 4px solid var(--secondary); }
        .panel-title { font-family: 'Fredoka One'; margin-bottom: 15px; font-size: 18px; color: #ddd; }
        .challenge-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }

        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .glass { background: #1a1a1a; border: 1px solid #333; padding: 30px; border-radius: 8px; width: 400px; text-align: center; position: relative; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; background: #222; border: 1px solid #444; color: white; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; margin-top: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-green { background: var(--primary); color: white; }
        
        /* SERVER BROWSER */
        #lobbyList { height: 300px; overflow-y: auto; background: #111; border: 1px solid #333; margin-bottom: 15px; }
        .lobby-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; align-items: center; }
        .lobby-item:hover { background: #222; }

        /* HUD */
        #hud { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #topBar { position: absolute; top: 10px; width: 100%; text-align: center; font-family: 'Fredoka One'; font-size: 24px; text-shadow: 2px 2px 0 #000; }
        #chatBox { position: absolute; bottom: 20px; left: 20px; width: 300px; pointer-events: auto; }
        #chatMsgs { height: 150px; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-end; font-size: 13px; text-shadow: 1px 1px 1px black; }
        #chatInput { background: rgba(0,0,0,0.5); display: none; border: 1px solid #555; border-radius: 4px; }
        #spawnMenu { display: none; } /* Deployment screen */
        
        /* KITS */
        .kit-container { display: flex; gap: 5px; justify-content: center; margin-bottom: 15px; }
        .kit-btn { background: #333; color: #aaa; border: 2px solid transparent; padding: 10px; cursor: pointer; flex: 1; text-align: center; font-size: 12px; font-weight: bold; }
        .kit-btn.selected { border-color: var(--primary); color: white; background: rgba(0,184,148,0.1); }
    </style>
</head>
<body>
    <div id="backdrop"></div>

    <div id="navbar">
        <div class="nav-logo">IMP CUBES</div>
        <div class="nav-links">
            <button class="nav-btn active">PLAY GAME</button>
            <button class="nav-btn" onclick="openShop()">SHOP</button>
            <button class="nav-btn">LEADERBOARD</button>
        </div>
        <div class="account-box" id="authBox">
            <button class="btn-green" style="padding: 5px 15px; width: auto;" onclick="document.getElementById('loginModal').style.display='flex'">LOGIN</button>
        </div>
        <div class="account-box" id="accBox" style="display:none;">
            <span id="usernameDisplay">Guest</span>
            <span class="currency">ðŸ’° <span id="cpDisplay">0</span></span>
            <button style="background:none; border:none; color:red; cursor:pointer; font-size:10px;" onclick="logout()">LOGOUT</button>
        </div>
    </div>

    <div id="deadshotMenu">
        <div class="side-panel left-panel">
            <div class="panel-title">DAILY CHALLENGES</div>
            <div class="challenge-row"><span>Play 2 Games</span><span>+100 CP</span></div>
            <div class="challenge-row"><span>Get 50 Kills</span><span>+500 CP</span></div>
            <div class="challenge-row"><span>Win 1 Match</span><span>+1000 CP</span></div>
        </div>

        <div class="center-char">
            <canvas id="charPreview" width="200" height="200" style="margin: 0 auto;"></canvas>
            <h2 id="charName" style="margin: 10px 0; font-size: 20px;">Guest</h2>
            <button class="play-btn-large" onclick="openBrowser()">PLAY</button>
            <div style="margin-top: 10px; color: #888; font-size: 12px;">1587 Players Online</div>
        </div>

        <div class="side-panel right-panel">
            <div class="panel-title">UPDATES</div>
            <div style="font-size: 12px; color: #ccc;">
                - Added Grapple Fix<br>
                - New UI Layout<br>
                - New Maps<br>
                - Juggernaut Mode
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal">
        <div class="glass">
            <h2>ACCOUNT</h2>
            <input id="user" placeholder="Username">
            <input id="pass" type="password" placeholder="Password">
            <input id="email" placeholder="Email (Owner Only)">
            <button class="btn btn-green" onclick="auth('login')">LOGIN</button>
            <button class="btn" style="background:#444; color:white;" onclick="auth('signup')">SIGN UP</button>
            <button class="btn" style="background:transparent; color:#888; margin-top:10px;" onclick="document.getElementById('loginModal').style.display='none'">Close</button>
            <div id="msg" style="margin-top:10px; color:red;"></div>
        </div>
    </div>

    <div id="browserModal" class="modal">
        <div class="glass" style="width: 700px;">
            <div style="display:flex; justify-content:space-between;">
                <h2>SERVERS</h2>
                <button class="btn" style="width:auto; background:red; padding:5px 10px;" onclick="document.getElementById('browserModal').style.display='none'">X</button>
            </div>
            
            <div style="display:flex; gap: 20px; text-align: left; margin-top: 20px;">
                <div style="flex: 2;">
                    <div id="lobbyList">Loading...</div>
                </div>
                <div style="flex: 1; border-left: 1px solid #333; padding-left: 20px;">
                    <h3>CREATE</h3>
                    <input id="newLobbyName" placeholder="Room Name">
                    <select id="modeSelect"><option value="FFA">FFA</option><option value="TDM">TDM</option><option value="KOTH">KOTH</option><option value="ZOMBIES">ZOMBIES</option><option value="JUGGERNAUT">JUGGERNAUT</option></select>
                    <select id="mapSelect"><option value="0">Arena</option><option value="1">Maze</option><option value="2">Towers</option><option value="3">Open Field</option></select>
                    <button class="btn btn-green" onclick="createLobby()">HOST</button>
                    
                    <h3 style="margin-top: 20px;">PRIVATE</h3>
                    <div style="display:flex; gap:5px;"><input id="codeIn" placeholder="CODE"><button class="btn" style="width:50px;" onclick="joinPrivate()">GO</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="spawnMenu" class="modal">
        <div class="glass">
            <h2>DEPLOYMENT</h2>
            <div class="kit-container">
                <div class="kit-btn selected" onclick="selKit('assault',this)">SOLDIER</div>
                <div class="kit-btn" onclick="selKit('shotgun',this)">BREACH</div>
                <div class="kit-btn" onclick="selKit('sniper',this)">RECON</div>
                <div class="kit-btn" onclick="selKit('tank',this)">HEAVY</div>
                <div class="kit-btn" onclick="selKit('ninja',this)">NINJA</div>
            </div>
            <button class="btn btn-green" onclick="spawn()">DEPLOY</button>
        </div>
    </div>

    <div id="hud">
        <div id="topBar"></div>
        <div id="chatBox"><div id="chatMsgs"></div><input id="chatInput"></div>
        <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 300px; text-align: center;">
            <div style="font-size: 20px; font-weight: bold; margin-bottom: 5px;" id="ammoDisplay">30/30</div>
            <div style="height: 8px; background: #333; border-radius: 4px;"><div id="hpBar" style="width: 100%; height: 100%; background: var(--primary); border-radius: 4px;"></div></div>
        </div>
    </div>

    <canvas id="game"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let myId=null, cam={x:0,y:0}, isPaused=false, particles=[], currentWalls=[], kit='assault', previewHat='none';

        // INPUT STATE
        const keys={w:0,a:0,s:0,d:0,shift:0};
        const mouse={x:0,y:0,down:0,right:0};

        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.onresize = resize; resize();

        // --- AUTH & INIT ---
        window.onload = () => {
            document.getElementById('deadshotMenu').style.display = 'block';
            startPreviewLoop();
            const u = localStorage.getItem('imp_user'), p = localStorage.getItem('imp_pass');
            if(u && p) auth('login', u, p);
        };

        function auth(t, uVal, pVal) {
            let u = uVal || document.getElementById('user').value;
            let p = pVal || document.getElementById('pass').value;
            let e = document.getElementById('email').value;
            socket.emit(t, {user: u, pass: p, email: e});
        }

        socket.on('authSuccess', d => {
            localStorage.setItem('imp_user', d.user); 
            if(d.pass) localStorage.setItem('imp_pass', d.pass);
            
            // Update UI
            document.getElementById('authBox').style.display = 'none';
            document.getElementById('accBox').style.display = 'flex';
            document.getElementById('usernameDisplay').innerText = d.user;
            document.getElementById('charName').innerText = d.user;
            document.getElementById('cpDisplay').innerText = d.money;
            document.getElementById('loginModal').style.display = 'none';
            previewHat = d.equippedHat || 'none';
        });

        socket.on('authMsg', d => { document.getElementById('msg').innerText = d.m; });

        function logout() { localStorage.clear(); location.reload(); }
        function openBrowser() { socket.emit('requestLobbies'); document.getElementById('browserModal').style.display='flex'; }
        
        // --- LOBBY LOGIC ---
        function createLobby() {
            socket.emit('createLobby', { 
                name: document.getElementById('newLobbyName').value, 
                isPublic: true, 
                mode: document.getElementById('modeSelect').value, 
                map: document.getElementById('mapSelect').value 
            });
        }
        function joinPublic(id) { socket.emit('joinLobby', id); }
        function joinPrivate() { socket.emit('joinLobby', document.getElementById('codeIn').value); }

        socket.on('lobbyList', list => {
            const c = document.getElementById('lobbyList'); c.innerHTML = "";
            list.forEach(l => {
                c.innerHTML += `<div class="lobby-item"><div><b>${l.name}</b> <small>${l.mode} (${l.count})</small></div><button class="btn btn-green" style="width:auto; padding:5px 15px;" onclick="joinPublic('${l.id}')">JOIN</button></div>`;
            });
        });

        socket.on('startGame', d => {
            myId = d.id; currentWalls = d.walls;
            document.getElementById('deadshotMenu').style.display = 'none';
            document.getElementById('navbar').style.display = 'none';
            document.getElementById('browserModal').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('spawnMenu').style.display = 'flex'; // Deploy screen
        });

        socket.on('mapChange', d => currentWalls = d.walls);
        socket.on('chatMsg', d => { const l=document.createElement('div'); l.innerHTML=`<span style="color:${d.nameColor||d.color}">${d.user}:</span> ${d.text}`; document.getElementById('chatMsgs').appendChild(l); });

        // --- GAME LOGIC ---
        function selKit(k, el) { kit=k; document.querySelectorAll('.kit-btn').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); }
        function spawn() { socket.emit('requestSpawn', kit); document.getElementById('spawnMenu').style.display = 'none'; }

        // INPUTS
        window.onkeydown = e => {
            if(document.activeElement.id==='chatInput') {
                if(e.code==='Enter') { socket.emit('chat', document.getElementById('chatInput').value); document.getElementById('chatInput').value=''; document.getElementById('chatInput').style.display='none'; }
                return;
            }
            if(e.code==='Enter') { document.getElementById('chatInput').style.display='block'; document.getElementById('chatInput').focus(); }
            keys[e.key.toLowerCase()] = 1; if(e.code==='ShiftLeft') keys.shift=1;
        };
        window.onkeyup = e => { keys[e.key.toLowerCase()] = 0; if(e.code==='ShiftLeft') keys.shift=0; };
        
        window.onmousemove = e => { mouse.x = e.clientX; mouse.y = e.clientY; };
        // FIXED GRAPPLE INPUT
        window.onmousedown = e => { 
            if(e.button===0) mouse.down=1; 
            if(e.button===2) { mouse.right=1; socket.emit('input', {grapple:true, gx:mouse.x+cam.x, gy:mouse.y+cam.y}); }
        };
        window.onmouseup = e => { 
            if(e.button===0) mouse.down=0; 
            if(e.button===2) { mouse.right=0; socket.emit('input', {grapple:false}); }
        };
        window.oncontextmenu = e => e.preventDefault();

        // RENDER LOOP
        socket.on('state', s => {
            if(!myId) return;
            const me = s.players[myId]; if(!me) return;
            
            // Death Screen
            if(me.dead && document.getElementById('spawnMenu').style.display === 'none') {
                document.getElementById('spawnMenu').style.display = 'flex';
            }

            cam.x += (me.x - canvas.width/2 - cam.x)*0.1;
            cam.y += (me.y - canvas.height/2 - cam.y)*0.1;

            ctx.fillStyle = "#1a1a1a"; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.save(); ctx.translate(-cam.x, -cam.y);

            // Map
            ctx.fillStyle = "#333";
            currentWalls.forEach(w => { ctx.fillRect(w.x, w.y, w.w, w.h); ctx.strokeStyle="#444"; ctx.strokeRect(w.x,w.y,w.w,w.h); });

            // Players
            for(let id in s.players) {
                let p = s.players[id]; if(p.dead) continue;
                drawChar(ctx, p.x, p.y, p.color, p.hat, p.angle, p.username, p.hp/p.maxHp);
                if(p.grapple.active) { ctx.beginPath(); ctx.moveTo(p.x+20,p.y+20); ctx.lineTo(p.grapple.x,p.grapple.y); ctx.strokeStyle='white'; ctx.lineWidth=2; ctx.stroke(); }
            }

            // Bullets
            s.bullets.forEach(b => { ctx.fillStyle=b.color; ctx.beginPath(); ctx.arc(b.x,b.y,5,0,7); ctx.fill(); });
            ctx.restore();

            // HUD Updates
            document.getElementById('topBar').innerText = `${s.game.mode}`;
            document.getElementById('hpBar').style.width = (me.hp/me.maxHp)*100+"%";
            document.getElementById('ammoDisplay').innerText = me.reloading ? "RELOADING" : `${me.ammo}/${me.maxAmmo}`;
        });

        // Loop for input
        setInterval(() => {
            if(!myId) return;
            let ang = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);
            socket.emit('input', {up:keys.w, down:keys.s, left:keys.a, right:keys.d, dash:keys.shift, shoot:mouse.down, angle:ang, gx:mouse.x+cam.x, gy:mouse.y+cam.y});
        }, 1000/60);

        // --- MENU PREVIEW RENDER ---
        function startPreviewLoop() {
            const pCtx = document.getElementById('charPreview').getContext('2d');
            function loop() {
                pCtx.clearRect(0,0,200,200);
                // Draw a big cube in center
                drawChar(pCtx, 80, 80, '#4488FF', previewHat, Date.now()/1000, null, 1);
                requestAnimationFrame(loop);
            }
            loop();
        }

        function drawChar(c, x, y, color, hat, angle, name, hpPct) {
            c.fillStyle = color; c.fillRect(x,y,40,40); // Body
            
            // Hat
            if(hat==='tophat') { c.fillStyle='#111'; c.fillRect(x,y-15,40,10); c.fillRect(x+5,y-35,30,25); }
            if(hat==='crown') { c.fillStyle='gold'; c.font='20px Arial'; c.fillText('ðŸ‘‘', x+10, y-10); }
            if(hat==='halo') { c.strokeStyle='gold'; c.lineWidth=2; c.beginPath(); c.ellipse(x+20, y-15, 15, 5, 0, 0, Math.PI*2); c.stroke(); }

            // Eyes
            c.fillStyle="white"; 
            c.beginPath(); c.arc(x+10, y+15, 6, 0, 7); c.fill();
            c.beginPath(); c.arc(x+30, y+15, 6, 0, 7); c.fill();
            c.fillStyle="black";
            let ex = Math.cos(angle)*4, ey = Math.sin(angle)*4;
            c.beginPath(); c.arc(x+10+ex, y+15+ey, 3, 0, 7); c.fill();
            c.beginPath(); c.arc(x+30+ex, y+15+ey, 3, 0, 7); c.fill();

            // Name & HP
            if(name) {
                c.fillStyle = "white"; c.font = "bold 12px Arial"; c.fillText(name, x, y-10);
                c.fillStyle = "red"; c.fillRect(x, y-6, 40, 4);
                c.fillStyle = "#00b894"; c.fillRect(x, y-6, 40*hpPct, 4);
            }
        }
    </script>
</body>
</html>
