<!DOCTYPE html>
<html>
<head>
    <title>Imp Cubes - KOTH/CTF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #0a0a10; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; user-select: none; }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        
        /* GLASS UI STYLES */
        .glass-panel { 
            background: rgba(20, 20, 30, 0.9); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 12px; 
            padding: 20px; 
            text-align: center; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        
        .overlay { 
            position: absolute; width: 100%; height: 100%; 
            z-index: 100; 
            display: flex; align-items: center; justify-content: center; 
            background: rgba(0,0,0,0.8); 
        }
        
        /* INPUTS & BUTTONS */
        .auth-input { 
            width: 100%; padding: 12px; margin-bottom: 8px; 
            background: rgba(0,0,0,0.5); border: 1px solid #444; 
            color: white; border-radius: 6px; box-sizing: border-box; 
        }
        
        .btn { 
            padding: 12px; border: none; font-weight: bold; 
            border-radius: 6px; width: 100%; cursor: pointer; 
            margin-top: 8px; transition: 0.2s; text-transform: uppercase;
        }
        .btn:hover { transform: scale(1.02); filter: brightness(1.1); }
        .btn-blue { background: #4488FF; color: white; }
        .btn-green { background: #00b894; color: white; }
        .btn-red { background: #ff4444; color: white; }
        
        /* KIT SELECTOR */
        .kit-container { display: flex; gap: 5px; margin: 10px 0; }
        .kit-btn { 
            flex: 1; padding: 10px 5px; background: #333; 
            border: 2px solid #444; color: #aaa; border-radius: 5px; 
            cursor: pointer; font-size: 11px; font-weight: bold;
        }
        .kit-btn.selected { 
            border-color: #4488FF; color: white; 
            background: rgba(68,136,255,0.2); 
        }

        /* HUD */
        #hud { 
            position: absolute; top: 10px; width: 100%; 
            text-align: center; pointer-events: none; z-index: 10;
        }
        .score-box { 
            display: inline-block; background: rgba(0,0,0,0.6); 
            padding: 8px 20px; border-radius: 20px; 
            font-weight: bold; font-size: 20px; border: 1px solid #444; 
            backdrop-filter: blur(4px);
        }
        
        /* LEADERBOARD */
        .leaderboard-row { 
            display: flex; justify-content: space-between; 
            padding: 10px; border-bottom: 1px solid #444; 
            width: 300px; font-size: 16px;
        }
        .rank-1 { color: #FFD700; font-weight: bold; font-size: 1.1em; } /* Gold */
        .rank-2 { color: #C0C0C0; font-weight: bold; } /* Silver */
        .rank-3 { color: #CD7F32; font-weight: bold; } /* Bronze */

        /* VOTING */
        .vote-container { display: flex; gap: 20px; margin-top: 10px; }
        .vote-section { width: 180px; }
        .vote-section h3 { border-bottom: 1px solid #555; padding-bottom: 5px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="mainMenu" class="overlay">
        <div class="glass-panel" style="width: 340px;">
            <h1 style="color:#4488FF; margin:0 0 15px 0; font-size: 2.5em; text-shadow: 0 0 10px rgba(68,136,255,0.5);">IMP CUBES</h1>
            
            <input id="user" class="auth-input" placeholder="Username">
            <input id="email" class="auth-input" placeholder="Email (Owner Perms)">
            <input id="pass" type="password" class="auth-input" placeholder="Password">
            
            <div style="text-align:left; font-size:12px; color:#aaa; margin-top:10px;">Select Class:</div>
            <div class="kit-container">
                <div class="kit-btn selected" onclick="selKit('shotgun',this)">BREACHER</div>
                <div class="kit-btn" onclick="selKit('assault',this)">SOLDIER</div>
                <div class="kit-btn" onclick="selKit('sniper',this)">RECON</div>
                <div class="kit-btn" onclick="selKit('tank',this)">TANK</div>
            </div>
            
            <button class="btn btn-blue" onclick="auth('login')">LOGIN & PLAY</button>
            <button class="btn btn-green" onclick="auth('signup')">CREATE ACCOUNT</button>
            <div id="msg" style="margin-top:10px; font-size:13px"></div>
        </div>
    </div>

    <div id="gameOverMenu" class="overlay" style="display:none;">
        <div class="glass-panel">
            <h1 style="color:gold; margin-top:0;">ROUND OVER</h1>
            <h2 id="winnerText" style="margin: 5px 0 20px 0;"></h2>
            
            <div style="background:rgba(0,0,0,0.3); border-radius:8px; overflow:hidden;">
                <div style="display:flex; justify-content:space-between; padding:10px; background:rgba(255,255,255,0.1); font-weight:bold; font-size:14px;">
                    <span>PLAYER</span><span>SCORE</span>
                </div>
                <div id="lbRows"></div>
            </div>
            
            <p style="color:#aaa; font-size:14px; margin-top:15px;">Next round starting soon...</p>
        </div>
    </div>

    <div id="voteMenu" class="overlay" style="display:none;">
        <div class="glass-panel">
            <h2 style="margin-top:0;">VOTE NEXT ROUND</h2>
            <div class="vote-container">
                <div class="vote-section">
                    <h3>MODE</h3>
                    <button class="btn btn-blue" onclick="vote('mode','FFA')">FFA (Solo)</button>
                    <button class="btn btn-blue" onclick="vote('mode','KOTH')">KOTH (Team)</button>
                    <button class="btn btn-blue" onclick="vote('mode','CTF')">CTF (Team)</button>
                </div>
                <div class="vote-section">
                    <h3>MAP</h3>
                    <button class="btn btn-blue" onclick="vote('map',0)">ARENA</button>
                    <button class="btn btn-blue" onclick="vote('map',1)">MAZE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="hud">
        <div class="score-box" id="topHud">WAITING...</div>
    </div>

    <canvas id="game"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        let myId=null, kit='shotgun', rgbTick=0;
        
        // --- UI FUNCTIONS ---
        function selKit(k,el) { kit=k; document.querySelectorAll('.kit-btn').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); }
        
        function auth(type) { 
            let u=document.getElementById('user').value, p=document.getElementById('pass').value, e=document.getElementById('email').value;
            socket.emit(type, {user:u, pass:p, email:e, kit:kit}); 
        }
        
        function vote(type, val) { 
            socket.emit('vote', {type, val}); 
            // Visual feedback could go here
            document.getElementById('voteMenu').style.display = 'none'; // Hide locally for now
        }

        socket.on('authMsg', d => {
            const el = document.getElementById('msg');
            el.innerText = d.msg; el.style.color = d.success ? '#0f0' : '#f55';
        });

        socket.on('startGame', d => { 
            myId=d.id; 
            document.getElementById('mainMenu').style.display='none'; 
        });

        // --- GAME OVER LOGIC ---
        socket.on('gameover', d => {
            document.getElementById('gameOverMenu').style.display = 'flex';
            document.getElementById('voteMenu').style.display = 'none';
            
            // Set Winner Text
            let winText = "FFA Winner: " + (d.top[0] ? d.top[0].username : "No One");
            let winColor = "gold";
            
            if (d.scores.red !== undefined) { // Team Mode
                if(d.scores.red > d.scores.blue) { winText = "RED TEAM WINS!"; winColor = "#ff4444"; }
                else if(d.scores.blue > d.scores.red) { winText = "BLUE TEAM WINS!"; winColor = "#4488ff"; }
                else { winText = "DRAW!"; winColor = "white"; }
            }
            const wTxt = document.getElementById('winnerText');
            wTxt.innerText = winText;
            wTxt.style.color = winColor;

            // Build Leaderboard Rows
            let html = "";
            d.top.forEach((p, i) => {
                let rankClass = i===0 ? 'rank-1' : (i===1 ? 'rank-2' : (i===2 ? 'rank-3' : ''));
                html += `<div class="leaderboard-row">
                            <span class="${rankClass}">#${i+1} ${p.username}</span> 
                            <span style="color:#aaa">${p.score}</span>
                         </div>`;
            });
            document.getElementById('lbRows').innerHTML = html;
        });

        // --- INPUTS ---
        const keys={w:0,a:0,s:0,d:0,shift:0}; const mouse={x:0,y:0,down:0,right:0};
        window.onkeydown=e=>{if(e.code=='KeyW')keys.w=1;if(e.code=='KeyS')keys.s=1;if(e.code=='KeyA')keys.a=1;if(e.code=='KeyD')keys.d=1;if(e.code=='ShiftLeft')keys.shift=1;};
        window.onkeyup=e=>{if(e.code=='KeyW')keys.w=0;if(e.code=='KeyS')keys.s=0;if(e.code=='KeyA')keys.a=0;if(e.code=='KeyD')keys.d=0;if(e.code=='ShiftLeft')keys.shift=0;};
        window.onmousedown=e=>{if(e.button==0)mouse.down=1;if(e.button==2)mouse.right=1;};
        window.onmouseup=e=>{if(e.button==0)mouse.down=0;if(e.button==2)mouse.right=0;};
        window.onmousemove=e=>{mouse.x=e.clientX; mouse.y=e.clientY;};
        window.oncontextmenu=e=>e.preventDefault();

        // --- RENDER LOOP ---
        socket.on('state', s => {
            if(!myId) return;
            const me = s.players[myId]; if(!me) return;
            const g = s.game;

            // 1. UPDATE HUD TEXT
            if(g.phase === 'GAME') {
                document.getElementById('gameOverMenu').style.display='none';
                let mins = Math.floor(g.timer/60);
                let secs = (g.timer%60).toString().padStart(2,'0');
                let hudHtml = `${mins}:${secs}`;
                
                if(g.mode !== 'FFA') {
                    hudHtml += ` | <span style="color:#ff5555">RED: ${g.scores.red}</span> - <span style="color:#4488ff">BLUE: ${g.scores.blue}</span>`;
                } else {
                    hudHtml += ` | FFA`;
                }
                document.getElementById('topHud').innerHTML = hudHtml;
            } 
            else if(g.phase === 'VOTE') {
                document.getElementById('gameOverMenu').style.display='none';
                document.getElementById('voteMenu').style.display='flex';
                document.getElementById('topHud').innerText = "VOTING...";
            }
            else if(g.phase === 'WARMUP') {
                 document.getElementById('topHud').innerText = "WARMUP";
            }

            // 2. RENDER GAME
            rgbTick+=2; const rainbow=`hsl(${rgbTick},100%,50%)`;
            const cam={x:me.x-canvas.width/2+20, y:me.y-canvas.height/2+20};

            // Background
            ctx.fillStyle="#121212"; ctx.fillRect(0,0,canvas.width,canvas.height);
            
            ctx.save(); ctx.translate(-cam.x, -cam.y);

            // Draw Walls
            ctx.fillStyle='#2a2a35'; 
            s.game.walls.forEach(w=>{
                ctx.fillRect(w.x,w.y,w.w,w.h); 
                ctx.strokeStyle='#3a3a45'; ctx.strokeRect(w.x,w.y,w.w,w.h);
            });

            // Draw KOTH Hill
            if(g.mode === 'KOTH' && g.hill) {
                ctx.fillStyle = 'rgba(255,255,0,0.15)'; 
                ctx.fillRect(g.hill.x, g.hill.y, g.hill.w, g.hill.h);
                ctx.lineWidth = 4;
                ctx.strokeStyle = (g.scores.red > g.scores.blue) ? '#ff4444' : ((g.scores.blue > g.scores.red) ? '#4488ff' : 'yellow');
                ctx.strokeRect(g.hill.x, g.hill.y, g.hill.w, g.hill.h);
                ctx.fillStyle='white'; ctx.font='bold 20px Arial'; ctx.fillText("HILL", g.hill.x+80, g.hill.y+105);
            }

            // Draw Players
            for(let id in s.players) {
                let p = s.players[id];
                let isOwner = p.maxHp>=500;
                
                // Grapple
                if(p.grapple.active){
                    ctx.beginPath(); ctx.moveTo(p.x+20,p.y+20); ctx.lineTo(p.grapple.x,p.grapple.y);
                    ctx.strokeStyle=isOwner?rainbow:'#fff'; ctx.lineWidth=2; ctx.stroke();
                }
                
                // Body
                ctx.fillStyle = isOwner ? rainbow : p.color; 
                ctx.fillRect(p.x, p.y, p.w, p.h);
                
                // --- EYES RENDERING
                const ang = p.angle;
                // Eye Whites
                ctx.fillStyle='white'; 
                ctx.beginPath(); ctx.arc(p.x+10, p.y+15, 6, 0, Math.PI*2); ctx.fill(); 
                ctx.beginPath(); ctx.arc(p.x+30, p.y+15, 6, 0, Math.PI*2); ctx.fill();
                // Pupils (Look at angle)
                const ex = Math.cos(ang)*4, ey = Math.sin(ang)*4;
                ctx.fillStyle='black'; 
                ctx.beginPath(); ctx.arc(p.x+10+ex, p.y+15+ey, 3, 0, Math.PI*2); ctx.fill(); 
                ctx.beginPath(); ctx.arc(p.x+30+ex, p.y+15+ey, 3, 0, Math.PI*2); ctx.fill();
                // ----------------------------------

                // Name
                ctx.fillStyle='white'; ctx.font='bold 12px Arial'; ctx.fillText(p.username, p.x, p.y-15);
                
                // HP Bar
                ctx.fillStyle='red'; ctx.fillRect(p.x, p.y-10, 40, 5); 
                ctx.fillStyle='#00e676'; ctx.fillRect(p.x, p.y-10, 40*(p.hp/p.maxHp), 5);
            }

            // Draw CTF Flags
            if(g.mode === 'CTF') {
                g.flags.forEach(f => {
                    ctx.fillStyle = f.team==='RED'?'#ff4444':'#4488ff';
                    ctx.beginPath(); ctx.arc(f.x, f.y, 12, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle='white'; ctx.font='10px Arial'; ctx.fillText("FLAG", f.x-12, f.y-15);
                });
            }

            // Draw Bullets
            s.bullets.forEach(b => { 
                ctx.beginPath(); ctx.arc(b.x, b.y, b.size, 0, Math.PI*2); 
                ctx.fillStyle=(b.owner===myId)?'white':(b.size>10?rainbow:'yellow'); 
                ctx.fill(); 
            });
            
            ctx.restore();
        });

        // INPUT LOOP
        setInterval(()=>{
            if(!myId)return;
            // No cam offset needed for logic, server handles absolute pos
            let ang = Math.atan2(mouse.y-canvas.height/2, mouse.x-canvas.width/2);
            socket.emit('input', {
                up:keys.w, down:keys.s, left:keys.a, right:keys.d, dash:keys.shift,
                shoot:mouse.down, grapple:mouse.right, angle:ang, gx:mouse.x, gy:mouse.y
            });
        }, 1000/60);
        

        // OVERRIDE INPUT LOOP WITH CORRECT COORDS
        let lastState = null;
        socket.on('state', s => lastState = s);
        
        
    </script>
    <script>
        // BETTER INPUT LOOP
        setInterval(()=>{
            if(!myId || !lastState) return;
            const me = lastState.players[myId]; if(!me) return;
            
            const camX = me.x - canvas.width/2 + 20;
            const camY = me.y - canvas.height/2 + 20;
            
            let ang = Math.atan2(mouse.y-canvas.height/2, mouse.x-canvas.width/2);
            
            socket.emit('input', {
                up:keys.w, down:keys.s, left:keys.a, right:keys.d, dash:keys.shift,
                shoot:mouse.down, grapple:mouse.right, angle:ang, 
                gx: mouse.x + camX, 
                gy: mouse.y + camY
            });
        }, 1000/60);
    </script>
</body>
</html>
