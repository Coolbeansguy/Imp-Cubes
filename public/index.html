<!DOCTYPE html>
<html>
<head>
    <title>Imp Cubes - KOTH/CTF</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { margin: 0; background: #0a0a10; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; touch-action: none; user-select: none; }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        
        .glass-panel { background: rgba(20, 20, 30, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; }
        .overlay { position: absolute; width: 100%; height: 100%; z-index: 100; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.8); }
        
        .btn { padding: 10px; border: none; font-weight: bold; border-radius: 6px; width: 100%; cursor: pointer; margin-top:5px; transition:0.2s; }
        .btn:hover { transform: scale(1.05); }
        .btn-blue { background: #4488FF; color: white; }
        .btn-red { background: #ff4444; color: white; }
        .kit-btn { flex: 1; padding: 10px 5px; background: #333; border: 2px solid #444; color: #aaa; border-radius: 5px; cursor: pointer; font-size: 11px; }
        .kit-btn.selected { border-color: #4488FF; color: white; background: rgba(68,136,255,0.2); }

        /* HUD */
        #hud { position: absolute; top: 10px; width: 100%; text-align: center; pointer-events: none; }
        .score-box { display: inline-block; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 18px; border: 1px solid #444; }
        
        /* LEADERBOARD */
        .leaderboard-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; width: 300px; }
        .rank-1 { color: gold; font-size: 1.2em; }
        .rank-2 { color: silver; }
        .rank-3 { color: #cd7f32; }

        /* VOTING */
        .vote-container { display: flex; gap: 20px; }
        .vote-section { width: 200px; }
    </style>
</head>
<body>

    <div id="mainMenu" class="overlay">
        <div class="glass-panel" style="width: 320px;">
            <h1 style="color:#4488FF; margin:0 0 10px 0;">IMP CUBES</h1>
            <input id="user" placeholder="Username" style="width:100%; padding:10px; margin-bottom:5px; background:#333; border:1px solid #555; color:white;">
            <input id="email" placeholder="Email (Owner)" style="width:100%; padding:10px; margin-bottom:5px; background:#333; border:1px solid #555; color:white;">
            <input id="pass" type="password" placeholder="Password" style="width:100%; padding:10px; margin-bottom:10px; background:#333; border:1px solid #555; color:white;">
            
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <div class="kit-btn selected" onclick="selKit('shotgun',this)">BREACHER</div>
                <div class="kit-btn" onclick="selKit('assault',this)">SOLDIER</div>
                <div class="kit-btn" onclick="selKit('sniper',this)">RECON</div>
                <div class="kit-btn" onclick="selKit('tank',this)">TANK</div>
            </div>
            
            <button class="btn btn-blue" onclick="auth('login')">LOGIN & PLAY</button>
            <button class="btn btn-blue" style="background:#00b894" onclick="auth('signup')">SIGN UP</button>
            <div id="msg" style="margin-top:5px; font-size:12px"></div>
        </div>
    </div>

    <div id="gameOverMenu" class="overlay" style="display:none;">
        <div class="glass-panel">
            <h1 style="color:gold">ROUND OVER</h1>
            <h3 id="winnerText"></h3>
            <div id="lbRows"></div>
            <p>Next round starting soon...</p>
        </div>
    </div>

    <div id="voteMenu" class="overlay" style="display:none;">
        <div class="glass-panel">
            <h2>VOTE NEXT ROUND</h2>
            <div class="vote-container">
                <div class="vote-section">
                    <h3>MODE</h3>
                    <button class="btn btn-blue" onclick="vote('mode','FFA')">FFA</button>
                    <button class="btn btn-blue" onclick="vote('mode','KOTH')">KOTH</button>
                    <button class="btn btn-blue" onclick="vote('mode','CTF')">CTF</button>
                </div>
                <div class="vote-section">
                    <h3>MAP</h3>
                    <button class="btn btn-blue" onclick="vote('map',0)">ARENA</button>
                    <button class="btn btn-blue" onclick="vote('map',1)">MAZE</button>
                </div>
            </div>
        </div>
    </div>

    <div id="hud">
        <div class="score-box" id="topHud">WARMUP</div>
    </div>

    <canvas id="game"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;

        let myId=null, kit='shotgun', rgbTick=0;
        
        function selKit(k,el) { kit=k; document.querySelectorAll('.kit-btn').forEach(b=>b.classList.remove('selected')); el.classList.add('selected'); }
        function auth(type) { 
            let u=document.getElementById('user').value, p=document.getElementById('pass').value, e=document.getElementById('email').value;
            socket.emit(type, {user:u, pass:p, email:e, kit:kit}); 
        }
        function vote(type, val) { socket.emit('vote', {type, val}); document.getElementById('voteMenu').style.display='none'; }

        socket.on('authMsg', d => document.getElementById('msg').innerText = d.msg);
        socket.on('startGame', d => { myId=d.id; document.getElementById('mainMenu').style.display='none'; });

        socket.on('gameover', d => {
            document.getElementById('gameOverMenu').style.display = 'flex';
            let winText = "FFA Winner: " + d.top[0].username;
            if(d.scores.red > d.scores.blue) winText = "RED TEAM WINS!";
            if(d.scores.blue > d.scores.red) winText = "BLUE TEAM WINS!";
            document.getElementById('winnerText').innerText = winText;

            let html = "";
            d.top.forEach((p, i) => {
                html += `<div class="leaderboard-row"><span class="rank-${i+1}">#${i+1} ${p.username}</span> <span>${p.score} pts</span></div>`;
            });
            document.getElementById('lbRows').innerHTML = html;
        });

        // INPUTS
        const keys={w:0,a:0,s:0,d:0,shift:0}; const mouse={x:0,y:0,down:0,right:0};
        window.onkeydown=e=>{if(e.code=='KeyW')keys.w=1;if(e.code=='KeyS')keys.s=1;if(e.code=='KeyA')keys.a=1;if(e.code=='KeyD')keys.d=1;if(e.code=='ShiftLeft')keys.shift=1;};
        window.onkeyup=e=>{if(e.code=='KeyW')keys.w=0;if(e.code=='KeyS')keys.s=0;if(e.code=='KeyA')keys.a=0;if(e.code=='KeyD')keys.d=0;if(e.code=='ShiftLeft')keys.shift=0;};
        window.onmousedown=e=>{if(e.button==0)mouse.down=1;if(e.button==2)mouse.right=1;};
        window.onmouseup=e=>{if(e.button==0)mouse.down=0;if(e.button==2)mouse.right=0;};
        window.onmousemove=e=>{mouse.x=e.clientX; mouse.y=e.clientY;};
        window.oncontextmenu=e=>e.preventDefault();

        socket.on('state', s => {
            if(!myId) return;
            const me = s.players[myId]; if(!me) return;
            const g = s.game;

            // UI LOGIC
            if(g.phase === 'GAME') document.getElementById('gameOverMenu').style.display='none';
            if(g.phase === 'VOTE') { document.getElementById('gameOverMenu').style.display='none'; document.getElementById('voteMenu').style.display='flex'; }
            else document.getElementById('voteMenu').style.display='none';

            let hudText = `${Math.floor(g.timer/60)}:${(g.timer%60).toString().padStart(2,'0')}`;
            if(g.mode !== 'FFA') hudText += ` | <span style="color:#ff5555">${g.scores.red}</span> - <span style="color:#4488ff">${g.scores.blue}</span>`;
            document.getElementById('topHud').innerHTML = hudText;

            // RENDER
            rgbTick+=2; const rainbow=`hsl(${rgbTick},100%,50%)`;
            const cam={x:me.x-canvas.width/2+20, y:me.y-canvas.height/2+20};

            ctx.fillStyle="#111"; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.save(); ctx.translate(-cam.x, -cam.y);

            // WALLS
            ctx.fillStyle='#333'; s.game.walls.forEach(w=>{ctx.fillRect(w.x,w.y,w.w,w.h); ctx.strokeStyle='#444'; ctx.strokeRect(w.x,w.y,w.w,w.h);});

            // ZONES (KOTH)
            if(g.mode === 'KOTH' && g.hill) {
                ctx.fillStyle = 'rgba(255,255,0,0.2)'; 
                ctx.fillRect(g.hill.x, g.hill.y, g.hill.w, g.hill.h);
                ctx.strokeStyle='yellow'; ctx.strokeRect(g.hill.x, g.hill.y, g.hill.w, g.hill.h);
                ctx.fillStyle='white'; ctx.fillText("HILL", g.hill.x+80, g.hill.y+100);
            }

            // PLAYERS
            for(let id in s.players) {
                let p = s.players[id];
                let isOwner = p.maxHp>=500;
                if(p.grapple.active){ctx.beginPath();ctx.moveTo(p.x+20,p.y+20);ctx.lineTo(p.grapple.x,p.grapple.y);ctx.strokeStyle=isOwner?rainbow:'#fff';ctx.stroke();}
                ctx.fillStyle = isOwner ? rainbow : p.color; ctx.fillRect(p.x, p.y, p.w, p.h);
                
                // Name
                ctx.fillStyle='white'; ctx.font='12px Arial'; ctx.fillText(p.username, p.x, p.y-15);
                // HP
                ctx.fillStyle='red'; ctx.fillRect(p.x, p.y-10, 40, 5); ctx.fillStyle='#0f0'; ctx.fillRect(p.x, p.y-10, 40*(p.hp/p.maxHp), 5);
            }

            // FLAGS (CTF)
            if(g.mode === 'CTF') {
                g.flags.forEach(f => {
                    ctx.fillStyle = f.team==='RED'?'red':'blue';
                    ctx.beginPath(); ctx.arc(f.x, f.y, 15, 0, Math.PI*2); ctx.fill();
                    ctx.fillStyle='white'; ctx.fillText("FLAG", f.x-15, f.y-20);
                });
            }

            // BULLETS
            s.bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, Math.PI*2); ctx.fillStyle=(b.owner===myId)?'white':'yellow'; ctx.fill(); });
            
            ctx.restore();
        });

        // INPUT LOOP
        setInterval(()=>{
            if(!myId)return;
            const cx=0, cy=0; // Cam offset handling would go here for mouse logic
            let ang = Math.atan2(mouse.y-canvas.height/2, mouse.x-canvas.width/2);
            socket.emit('input', {
                up:keys.w, down:keys.s, left:keys.a, right:keys.d, dash:keys.shift,
                shoot:mouse.down, grapple:mouse.right, angle:ang, gx:mouse.x, gy:mouse.y
            });
        }, 1000/60);
    </script>
</body>
</html>
