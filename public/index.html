<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Imp Cubes: Ultimate</title>
    <link rel="icon" type="image/png" href="https://media.discordapp.net/attachments/1286433136804106282/1472114823369330689/image.png?ex=69916544&is=699013c4&hm=6e53418ccc28321ed6703073c2da8530a6e16e4680acae446d8a83c2372b6352">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #4488FF; --accent: #FFD700; --bg: #0a0a10; }
        body { margin: 0; background: var(--bg); overflow: hidden; font-family: 'Nunito', sans-serif; color: white; touch-action: none; user-select: none; }
        canvas { display: block; }
        .glass { background: rgba(30,35,45,0.95); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); text-align: center; position: relative; }
        .overlay { position: absolute; width: 100%; height: 100%; z-index: 100; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.9); }
        .site-logo { width: 150px; height: 150px; border-radius: 20px; margin-bottom: 25px; box-shadow: 0 0 30px var(--primary); }
        h2 { font-family: 'Fredoka One'; color: var(--primary); margin: 0; margin-bottom: 15px; }
        .btn { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 8px; font-family: 'Fredoka One'; cursor: pointer; text-transform: uppercase; transition: 0.1s; }
        .btn-blue { background: var(--primary); color: white; } .btn-green { background: #00b894; color: white; }
        input, select { width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(0,0,0,0.5); border: 2px solid #444; color: white; border-radius: 8px; box-sizing: border-box; }
        #hud { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        #topBar { position: absolute; top: 15px; width: 100%; text-align: center; font-family: 'Fredoka One'; font-size: 24px; text-shadow: 2px 2px 0 #000; }
        #lobbyMenu { display: none; } 
        #lobbyContainer { display: flex; gap: 20px; text-align: left; }
        #lobbyList { flex: 1.5; background: rgba(0,0,0,0.3); border-radius: 8px; height: 350px; overflow-y: auto; padding: 10px; }
        #createPanel { flex: 1; border-left: 1px solid #444; padding-left: 20px; }
        .lobby-item { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 12px; margin-bottom: 8px; border-radius: 8px; }
        #chatBox { position: absolute; bottom: 20px; left: 20px; width: 300px; pointer-events: auto; }
        #chatMsgs { height: 150px; overflow-y: auto; display: flex; flex-direction: column; justify-content: flex-end; font-weight: bold; font-size: 13px; }
        #chatInput { background: rgba(0,0,0,0.6); display: none; width: 100%; color: white; border: 1px solid #666; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="mainMenu" class="overlay">
        <div class="glass" style="width: 350px;">
            <img src="https://media.discordapp.net/attachments/1286433136804106282/1472114823369330689/image.png?ex=69916544&is=699013c4&hm=6e53418ccc28321ed6703073c2da8530a6e16e4680acae446d8a83c2372b6352" class="site-logo">
            <input id="user" placeholder="Username">
            <input id="pass" type="password" placeholder="Password">
            <button class="btn btn-blue" onclick="auth('login')">LOGIN</button>
            <button class="btn btn-green" onclick="auth('signup')">SIGN UP</button>
            <div id="msg" style="margin-top:10px; font-size:12px;"></div>
        </div>
    </div>

    <div id="lobbyMenu" class="overlay">
        <div class="glass" style="width: 750px;">
            <h2>SERVER BROWSER</h2>
            <div id="lobbyContainer">
                <div id="lobbyList"></div>
                <div id="createPanel">
                    <h3>CREATE ROOM</h3>
                    <input id="newLobbyName" placeholder="Lobby Name">
                    <select id="modeSelect">
                        <option value="FFA">FFA</option>
                        <option value="KOTH">KOTH</option>
                        <option value="ZOMBIES">ZOMBIES</option>
                    </select>
                    <button class="btn btn-green" onclick="createLobby()">START SERVER</button>
                </div>
            </div>
        </div>
    </div>

    <div id="hud">
        <div id="topBar"></div>
        <div id="chatBox"><div id="chatMsgs"></div><input id="chatInput" placeholder="Press Enter to Chat"></div>
        <div id="statsArea" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 300px;">
            <div class="bar" style="height: 10px;"><div id="hpBar" class="fill" style="background:#ff4757; width: 100%;"></div></div>
        </div>
    </div>

    <canvas id="game"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        let myId = null, cam = {x:0, y:0}, currentWalls = [], currentMode = "FFA";

        const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.onresize = resize; resize();

        // Auth Logic
        function auth(t) { socket.emit(t, {user: val('user'), pass: val('pass')}); }
        function val(id) { return document.getElementById(id).value; }
        function createLobby() { socket.emit('createLobby', { name: val('newLobbyName'), mode: val('modeSelect') }); }
        function joinPublic(id) { socket.emit('joinLobby', id); }

        socket.on('authSuccess', d => {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('lobbyMenu').style.display = 'flex';
            socket.emit('requestLobbies');
        });

        socket.on('lobbyList', list => {
            const cont = document.getElementById('lobbyList'); cont.innerHTML = "";
            list.forEach(l => {
                cont.innerHTML += `<div class="lobby-item">
                    <div><b>${l.name}</b><br><small>${l.mode} | ${l.count} Players</small></div>
                    <button class="btn-green" style="width:auto;padding:5px 10px;" onclick="joinPublic('${l.id}')">JOIN</button>
                </div>`;
            });
        });

        // FIXED: This listener ensures map and mode update when joining
        socket.on('startGame', d => {
            myId = d.id;
            currentWalls = d.walls;
            currentMode = d.mode;
            document.getElementById('lobbyMenu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
        });

        // FIXED: Map Change during round
        socket.on('mapChange', d => {
            currentWalls = d.walls;
            currentMode = d.mode;
        });

        // Game Loop Drawing
        socket.on('state', s => {
            if(!myId) return;
            const me = s.players[myId]; if(!me) return;
            const g = s.game;

            cam.x += (me.x - canvas.width/2 - cam.x) * 0.1;
            cam.y += (me.y - canvas.height/2 - cam.y) * 0.1;

            ctx.fillStyle = "#0a0a10"; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.save(); ctx.translate(-cam.x, -cam.y);

            // Draw Map
            ctx.fillStyle = "#2d3436";
            currentWalls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));

            // Draw Players
            for(let id in s.players) {
                let p = s.players[id]; if(p.dead) continue;
                ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.w, p.h);
                ctx.fillStyle = "white"; ctx.fillText(p.username, p.x, p.y - 10);
            }
            ctx.restore();

            document.getElementById('topBar').innerText = `${currentMode} | Score: ${g.scores.red} - ${g.scores.blue}`;
            document.getElementById('hpBar').style.width = (me.hp / me.maxHp) * 100 + "%";
        });

        // Input
        const keys = {};
        window.onkeydown = e => { 
            if(e.code === 'Enter') {
                const input = document.getElementById('chatInput');
                if(input.style.display === 'block') {
                    socket.emit('chat', input.value); input.value = ""; input.style.display = 'none';
                } else { input.style.display = 'block'; input.focus(); }
            }
            keys[e.key.toLowerCase()] = 1; 
        };
        window.onkeyup = e => keys[e.key.toLowerCase()] = 0;

        setInterval(() => {
            if(!myId) return;
            socket.emit('input', {up: keys.w, down: keys.s, left: keys.a, right: keys.d});
        }, 1000/60);
    </script>
</body>
</html>
