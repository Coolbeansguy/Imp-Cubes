<!DOCTYPE html>
<html>
<head>
    <title>Imp Cubes - CP Update</title>
    <style>
        body { margin: 0; background: #111; overflow: hidden; font-family: 'Segoe UI', sans-serif; color: white; }
        canvas { display: block; position: absolute; top: 0; left: 0; }

        /* MENU STYLES */
        #menu { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .box { background: #222; padding: 20px; border: 2px solid #4488FF; width: 300px; text-align: center; border-radius: 10px; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; background: #333; color: white; border: 1px solid #555; border-radius: 5px; }
        button { cursor: pointer; background: #4488FF; font-weight: bold; }
        button:hover { background: #6699FF; }

        /* HUD STYLES */
        #hud { position: absolute; top: 10px; left: 10px; z-index: 5; display: none; pointer-events: none; }
        
        /* SHOP BUTTON (Bottom Left) */
        #shopBtn { position: absolute; bottom: 20px; left: 20px; z-index: 20; display: none; }
        #shopBtn button { background: linear-gradient(45deg, #FFD700, #FFA500); color: black; border: 2px solid white; box-shadow: 0 0 10px gold; width: auto; padding: 10px 20px; }
        
        /* SHOP MENU (Centered) */
        #shopMenu { 
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: #1a1a1a; border: 4px solid #FFD700; padding: 20px; z-index: 30; 
            text-align: center; width: 400px; border-radius: 15px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }
        .item { display: flex; justify-content: space-between; align-items: center; background: #333; margin: 10px 0; padding: 10px; border-radius: 5px; }
        .buyBtn { background: #28a745; width: 100px; }
    </style>
</head>
<body>

    <div id="menu">
        <div class="box">
            <h1 style="color: #4488FF;">IMP CUBES</h1>
            <input id="username" placeholder="Username">
            <input id="color" type="color" value="#4488FF">
            <input id="email" placeholder="Email (Staff Only)">
            <button onclick="play()">PLAY</button>
        </div>
    </div>

    <div id="hud">
        <h3>WASD: Move | SHIFT: Sprint | CLICK: Shoot</h3>
    </div>

    <div id="shopBtn">
        <button onclick="toggleShop()">OPEN SHOP (<span id="cpDisplay">0</span> CP)</button>
    </div>

    <div id="shopMenu">
        <h2 style="color: #FFD700; margin-top: 0;">CUBE POINTS SHOP</h2>
        <p>Spend your CP on hats!</p>
        
        <div class="item">
            <div style="text-align: left;">
                <strong style="color: white;">Top Hat</strong><br>
                <span style="color: #888; font-size: 12px;">Classy & Fancy</span>
            </div>
            <button class="buyBtn" onclick="buy('hat_top')">100 CP</button>
        </div>

        <div class="item">
            <div style="text-align: left;">
                <strong style="color: white;">Fez</strong><br>
                <span style="color: #888; font-size: 12px;">Cool Red Hat</span>
            </div>
            <button class="buyBtn" onclick="buy('hat_fez')">250 CP</button>
        </div>

        <button onclick="toggleShop()" style="background: #dc3545; margin-top: 15px;">CLOSE</button>
    </div>

    <canvas id="game"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let myId = null;
        let gameActive = false;
        
        // INPUTS
        const keys = {};
        const mouse = { x: 0, y: 0 };
        let mouseDown = false;
        let rightDown = false;

        function play() {
            const user = document.getElementById('username').value || "Guest";
            const col = document.getElementById('color').value;
            const em = document.getElementById('email').value;
            socket.emit('join', { username: user, color: col, email: em });
        }

        function toggleShop() {
            const menu = document.getElementById('shopMenu');
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        }

        function buy(item) {
            socket.emit('buy', item);
        }

        socket.on('init', (data) => {
            myId = data.id;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('hud').style.display = 'block';
            document.getElementById('shopBtn').style.display = 'block'; // Show Shop Button
            gameActive = true;
        });

        window.onkeydown = e => keys[e.code] = true;
        window.onkeyup = e => keys[e.code] = false;
        window.onmousemove = e => { mouse.x = e.clientX; mouse.y = e.clientY; };
        window.onmousedown = e => { if(e.button===0) mouseDown=true; if(e.button===2) rightDown=true; };
        window.onmouseup = e => { if(e.button===0) mouseDown=false; if(e.button===2) rightDown=false; };
        window.oncontextmenu = e => e.preventDefault();

        // RENDER LOOP
        socket.on('state', (state) => {
            if(!gameActive || !myId) return;

            const me = state.players[myId];
            if(!me) return;

            // UPDATE UI CUBE POINTS
            document.getElementById('cpDisplay').innerText = me.money;

            const cam = { x: me.x - canvas.width/2 + 20, y: me.y - canvas.height/2 + 20 };

            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(-cam.x, -cam.y);

            // Draw Walls
            ctx.fillStyle = '#333';
            state.walls.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));

            // Draw Players
            for(let id in state.players) {
                const p = state.players[id];
                
                // Grapple
                if(p.grapple.active) {
                    ctx.beginPath(); ctx.moveTo(p.x+20, p.y+20); ctx.lineTo(p.grapple.x, p.grapple.y);
                    ctx.strokeStyle = '#fff'; ctx.stroke();
                }

                // Body
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x, p.y, p.w, p.h);

                // Hats (Visuals)
                if(p.hat === 'top_hat') {
                    ctx.fillStyle = '#111';
                    ctx.fillRect(p.x, p.y - 10, 40, 10); // Brim
                    ctx.fillRect(p.x + 5, p.y - 35, 30, 25); // Top
                }
                if(p.hat === 'hat_fez') {
                    ctx.fillStyle = '#b00';
                    ctx.fillRect(p.x + 5, p.y - 15, 30, 15);
                    ctx.fillStyle = 'gold'; // Tassel
                    ctx.fillRect(p.x + 15, p.y - 15, 5, 10);
                }

                // Eyes
                const angle = p.angle;
                const ex = Math.cos(angle)*5, ey = Math.sin(angle)*5;
                ctx.fillStyle='white'; 
                ctx.beginPath(); ctx.arc(p.x+10, p.y+15, 6, 0, 7); ctx.fill();
                ctx.beginPath(); ctx.arc(p.x+30, p.y+15, 6, 0, 7); ctx.fill();
                ctx.fillStyle='black';
                ctx.beginPath(); ctx.arc(p.x+10+ex, p.y+15+ey, 3, 0, 7); ctx.fill();
                ctx.beginPath(); ctx.arc(p.x+30+ex, p.y+15+ey, 3, 0, 7); ctx.fill();

                // Name
                ctx.fillStyle = 'white'; ctx.font = '12px Arial';
                ctx.fillText(p.username, p.x, p.y - 25);
                
                // HP
                ctx.fillStyle = 'red'; ctx.fillRect(p.x, p.y-10, 40, 5);
                ctx.fillStyle = '#0f0'; ctx.fillRect(p.x, p.y-10, 40*(p.hp/p.maxHp), 5);
            }

            // Draw Bullets
            state.bullets.forEach(b => {
                ctx.beginPath(); ctx.arc(b.x, b.y, b.size, 0, Math.PI*2);
                ctx.fillStyle = b.color; ctx.fill();
            });

            ctx.restore();
        });

        setInterval(() => {
            if(!gameActive) return;
            // Calculate Angle
            const camX = (state && state.players[myId]) ? state.players[myId].x - canvas.width/2 : 0;
            const camY = (state && state.players[myId]) ? state.players[myId].y - canvas.height/2 : 0;
            const angle = Math.atan2(mouse.y - canvas.height/2, mouse.x - canvas.width/2);
            
            socket.emit('input', {
                up: keys['KeyW'], down: keys['KeyS'], left: keys['KeyA'], right: keys['KeyD'],
                sprint: keys['ShiftLeft'], shoot: mouseDown, grapple: rightDown,
                angle: angle, gx: mouse.x + camX, gy: mouse.y + camY
            });
        }, 1000/60);

        let state = null;
        socket.on('state', s => state = s);
    </script>
</body>
</html>
